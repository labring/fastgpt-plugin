# Metaso 插件开发计划

## 📋 项目信息

**项目名称**: Metaso 工具集插件  
**开发架构**: Children ToolSet  
**技术栈**: TypeScript + FastGPT Plugin Framework  

## 🎯 开发目标

基于 Metaso API 开发一个功能完整的工具集，包含搜索、问答、网页读取三个子工具，采用 Children ToolSet 架构确保代码模块化和可维护性。

## 📅 开发计划

### 阶段一：项目初始化 (第1天)

#### 1.1 项目结构搭建
- [ ] 创建 metaso 主目录
- [ ] 建立标准的 Children ToolSet 目录结构
- [ ] 添加 package.json 和基础配置文件
- [ ] 创建 logo.svg 图标文件

#### 1.2 共享模块框架
- [ ] 创建 shared/ 目录结构
- [ ] 实现基础的类型定义 (shared/types.ts)
- [ ] 搭建配置管理框架 (shared/config.ts)
- [ ] 创建 API 客户端框架 (shared/api.ts)

**验收标准**:
- 目录结构完整且符合规范
- 基础文件创建完成
- TypeScript 编译无错误

### 阶段二：搜索工具开发 

#### 2.1 搜索工具实现
- [ ] 创建 children/search/ 目录结构
- [ ] 实现搜索工具配置 (children/search/config.ts)
- [ ] 开发搜索核心逻辑 (children/search/src/index.ts)
- [ ] 定义搜索类型 (children/search/src/types.ts)
- [ ] 创建搜索工具导出 (children/search/index.ts)

#### 2.2 API 客户端完善
- [ ] 实现 Metaso 搜索 API 调用
- [ ] 添加请求参数验证
- [ ] 实现响应数据处理
- [ ] 添加错误处理机制

#### 2.3 功能验证
- [ ] npx `tsc --noEmit --skipLibCheck` 测试代码
- [ ] 运行 `npm run build` 验证构建
- [ ] 使用 `bun run dev` 启动开发服务器
- [ ] 测试搜索功能的基本调用
- [ ] 验证参数传递和结果返回
- [ ] 确认错误处理机制

**验收标准**:
- 搜索工具功能完整且正确
- 构建成功无错误
- API 调用稳定可靠
- 错误处理完善

### 阶段三：问答工具开发 (第3天)

#### 3.1 问答工具实现
- [ ] 创建 children/ask/ 目录结构
- [ ] 基于搜索工具模板实现问答配置
- [ ] 开发问答核心逻辑
- [ ] 定义问答专用类型
- [ ] 创建问答工具导出

#### 3.2 API 扩展
- [ ] 实现 Metaso 问答 API 调用
- [ ] 适配问答接口参数
- [ ] 处理问答响应格式
- [ ] 优化错误提示信息

#### 3.3 功能验证
- [ ] 验证问答工具独立功能
- [ ] 测试与搜索工具的兼容性
- [ ] 确认构建和部署正常

**验收标准**:
- 问答工具功能正确
- 与搜索工具无冲突
- 构建部署成功

### 阶段四：网页读取工具开发 (第4天)

#### 4.1 网页读取工具实现
- [ ] 创建 children/reader/ 目录结构
- [ ] 实现网页读取工具配置
- [ ] 开发网页读取核心逻辑
- [ ] 定义网页读取类型
- [ ] 创建网页读取工具导出

#### 4.2 API 完善
- [ ] 实现 Metaso 网页读取 API 调用
- [ ] 处理 URL 参数验证
- [ ] 实现内容格式化
- [ ] 添加网页解析错误处理

#### 4.3 功能验证
- [ ] 验证网页读取功能
- [ ] 测试三个工具的整体兼容性
- [ ] 确认所有功能正常工作

**验收标准**:
- 网页读取工具功能完整
- 三个子工具协调工作
- 整体功能稳定可靠

### 阶段五：工具集集成 (第5天)

#### 5.1 主配置文件实现
- [ ] 创建工具集主配置 (config.ts)
- [ ] 实现工具集导出 (index.ts)
- [ ] 配置 children 数组
- [ ] 设置工具集元信息

#### 5.2 共享模块优化
- [ ] 完善 API 客户端功能
- [ ] 优化配置管理
- [ ] 统一错误处理
- [ ] 添加工具函数

#### 5.3 整体测试
- [ ] 运行完整构建测试
- [ ] 验证 FastGPT 集成
- [ ] 测试所有子工具功能
- [ ] 确认用户界面正常

**验收标准**:
- 工具集完整集成
- 所有功能正常工作
- FastGPT 界面显示正确
- 用户体验良好

### 阶段六：文档和优化 (第6天)

#### 6.1 文档完善
- [ ] 更新开发日志
- [ ] 编写使用说明
- [ ] 添加 API 文档
- [ ] 创建示例代码

#### 6.2 代码优化
- [ ] 代码重构和优化
- [ ] 添加详细注释
- [ ] 性能优化
- [ ] 安全性检查

#### 6.3 最终验证
- [ ] 完整功能测试
- [ ] 性能测试
- [ ] 安全性测试
- [ ] 用户体验测试

**验收标准**:
- 文档完整准确
- 代码质量高
- 性能表现良好
- 安全性符合要求

## 🚨 关键开发原则（基于 KnowS 插件经验）

### 开发顺序要求（必须严格遵守）
**⚠️ 核心原则：先开发一个子功能，确保代码完全正确后，再快速开发其他功能**

1. **单一功能优先**：选择最简单的子工具（如 search）先完成开发
2. **完整验证**：确保该子工具的所有代码（config.ts、types.ts、index.ts）都正确无误
3. **构建测试**：运行 `bun run build` 确保构建成功
4. **功能测试**：验证该子工具功能正常
5. **复制扩展**：基于正确的模板快速开发其他子工具
6. **避免全量开发**：禁止一次性开发所有功能后重复修改全部代码

**错误示例**：❌ 同时开发 3 个子工具 → 发现错误 → 修改 3 个文件 → 重复 5 次
**正确示例**：✅ 开发 search 工具 → 验证正确 → 复制模板开发其他 2 个工具

## 🐛 高频错误修复指南（基于实战经验）

### 1. TypeScript 类型错误

#### 错误1：未定义类型引用
**错误描述**：`Cannot find name 'SearchResult'` 或类似的类型未定义错误
**修复方法**：
```typescript
// ❌ 错误代码
export interface SearchToolOutput {
  results: SearchResult[];  // SearchResult 类型未定义
}

// ✅ 正确代码
export interface SearchToolOutput {
  results: MetasoSearchResult[];  // 使用已定义的类型
}

export interface MetasoSearchResult {
  id: string;
  title: string;
  content: string;
  url: string;
}
```

#### 错误2：导入路径错误
**修复方法**：
```typescript
// ❌ 错误代码
import { SearchResult } from '../shared/types';  // 路径错误

// ✅ 正确代码
import { MetasoSearchResult } from '../shared/types';  // 确保路径和导出名正确
```

### 2. FastGPT 配置错误

#### 错误3：工具类型枚举错误
```typescript
// ❌ 错误代码
export const config = defineToolSet({
  type: 'tool',  // 错误的类型值
});

// ✅ 正确代码
export const config = defineToolSet({
  type: ToolTypeEnum.tools,  // 使用正确的枚举值
});
```

#### 错误4：配置结构错误
```typescript
// ❌ 错误代码
versionList: [
  {
    version: '1.0.0',  // 错误的属性名
  }
]

// ✅ 正确代码
versionList: [
  {
    value: '1.0.0',  // 正确的属性名
  }
]
```

### 3. 输入输出参数配置错误

#### 错误5：缺少必需的参数属性
```typescript
// ❌ 错误代码
{
  key: 'query',
  valueType: WorkflowIOValueTypeEnum.string,
  label: '查询内容',
  // 缺少 toolDescription
}

// ✅ 正确代码
{
  key: 'query',
  valueType: WorkflowIOValueTypeEnum.string,
  label: '查询内容',
  toolDescription: '输入要搜索的内容',  // 添加必需属性
  renderTypeList: [FlowNodeInputTypeEnum.textarea],
  required: true
}
```

### 4. ToolSet 配置错误（关键错误）

#### 错误6：Cannot read properties of undefined (reading '0')
**错误描述**：FastGPT 主程序无法显示插件
**修复方法**：
```typescript
// ❌ 错误代码 - 缺少 children 数组
export default defineToolSet({
  name: { 'zh-CN': 'Metaso 搜索' },
  type: ToolTypeEnum.tools,
  // 缺少 children 数组配置
});

// ✅ 正确代码 - 添加 children 数组
import search from './children/search';
import qa from './children/qa';
import webReader from './children/webReader';

export default defineToolSet({
  name: { 'zh-CN': 'Metaso 搜索' },
  type: ToolTypeEnum.tools,
  children: [search, qa, webReader]  // 必须包含所有子工具
});
```

#### 错误7：子工具导出结构错误
```typescript
// ❌ 错误代码 - 错误的导出结构
export default {
  InputType,
  OutputType,
  toolCb,
  config
};

// ✅ 正确代码 - 使用 exportTool 函数
import { exportTool } from '@tool/utils/tool';

export default exportTool({
  toolCb,
  InputType,
  OutputType,
  config
});
```

### 5. 字符编码错误

#### 错误8：全角字符导致语法错误
```typescript
// ❌ 错误代码（全角字符）
const config = {
  name: 'Metaso 搜索'，  // 全角逗号
  description: '智能搜索工具'；  // 全角分号
}

// ✅ 正确代码（半角字符）
const config = {
  name: 'Metaso 搜索',  // 半角逗号
  description: '智能搜索工具';  // 半角分号
}
```

### 6. 多语言配置错误

#### 错误9：缺少多语言支持
```typescript
// ❌ 错误代码
name: 'Metaso 搜索',
description: '智能搜索工具',

// ✅ 正确代码
name: {
  'zh-CN': 'Metaso 搜索',
  'en-US': 'Metaso Search'
},
description: {
  'zh-CN': '智能搜索工具',
  'en-US': 'Intelligent search tool'
},
```

## 🚨 关键风险和应对策略

### 1. Children 架构风险
**风险**: Children ToolSet 架构复杂，容易出现配置错误  
**应对**: 严格按照模板开发，每个阶段都进行构建验证

### 2. API 集成风险
**风险**: Metaso API 调用可能不稳定或参数变化  
**应对**: 实现完善的错误处理和重试机制

### 3. 类型安全风险
**风险**: TypeScript 类型定义错误导致运行时问题  
**应对**: 使用 Zod 进行运行时类型验证

### 4. 构建部署风险
**风险**: FastGPT 集成可能出现兼容性问题  
**应对**: 每个阶段都进行构建测试，及时发现问题

## 📊 进度跟踪

### 开发进度表
| 阶段 | 计划时间 | 主要任务 | 状态 | 完成度 |
|------|----------|----------|------|--------|
| 阶段一 | 第1天 | 项目初始化 | 待开始 | 0% |
| 阶段二 | 第2天 | 搜索工具开发（优先验证） | 待开始 | 0% |
| 阶段三 | 第3天 | 问答工具开发 | 待开始 | 0% |
| 阶段四 | 第4天 | 网页读取工具开发 | 待开始 | 0% |
| 阶段五 | 第5天 | 工具集集成 | 待开始 | 0% |
| 阶段六 | 第6天 | 文档和优化 | 待开始 | 0% |

### 质量检查点
- [ ] 每日构建测试通过
- [ ] TypeScript 类型检查无错误
- [ ] 功能测试覆盖完整
- [ ] 代码审查通过
- [ ] 文档更新及时

### 关键检查点（基于实战经验）
- [ ] 确保主配置文件导入了所有子工具
- [ ] 确保 children 数组包含所有子工具
- [ ] 确保所有子工具使用 exportTool 函数导出
- [ ] 确保导入路径正确（'./src' 而不是 './src/index'）
- [ ] 确认错误处理机制
- [ ] 确认多语言配置完整
- [ ] 确认所有代码使用半角字符

## 🎯 成功标准
- [ ] 三个子工具功能完整且正确
- [ ] API 调用稳定可靠
- [ ] 错误处理机制完善
- [ ] 用户界面友好

### 技术标准
- [ ] TypeScript 类型安全
- [ ] 代码结构清晰模块化
- [ ] 符合 FastGPT 开发规范
- [ ] 构建部署成功

### 质量标准
- [ ] 代码质量高，注释完整
- [ ] 性能表现良好
- [ ] 安全性符合要求
- [ ] 文档完整准确


### 功能标准
1. **核心功能完整性**
   - 所有 3 个子工具功能正常
   - API 调用成功率 > 95%
   - 错误处理覆盖所有异常场景

2. **代码质量标准**
   - TypeScript 严格模式无错误
   - 单元测试覆盖率 > 80%
   - ESLint 检查无警告

3. **用户体验标准**
   - 响应时间 < 5 秒
   - 错误信息友好易懂
   - 配置简单直观

### 交付标准
1. **代码交付**
   - 完整的源代码
   - 详细的 README 文档
   - API 使用示例

2. **文档交付**
   - 开发设计文档
   - 用户使用指南
   - 故障排除指南

## 📝 开发备注

### 重要提醒
1. **严格遵循 FastGPT 插件开发规范**
2. **优先保证代码质量，避免技术债务**
3. **及时记录开发过程中的问题和解决方案**
4. **保持与团队的沟通，及时同步进度**

### 开发常用指令（基于实战经验）
- `npx tsc --noEmit --skipLibCheck`: 类型检查，确保 TypeScript 类型正确
- `bun run build`: 构建项目，验证配置正确性
- `bun run dev`: 开发模式运行
- `bun test`: 运行单元测试

### 参考资源
- FastGPT 插件开发文档
- Metaso API 官方文档
- TypeScript 最佳实践指南
- Children ToolSet 开发指南
- KnowS 插件开发经验总结
- /Users/qinxiaoqiang/Downloads/fastgpt-plugin-1/modules/tool/packages/jinaAi 开发代码，其实和 Metaso 插件类似
---

**注意**：本开发计划基于 KnowS 插件的成功开发经验制定，重点关注避免常见错误和提高开发效率。开发过程中如遇到问题，请优先参考高频错误修复指南。

这个开发计划确保了 Metaso 插件的高质量交付，特别关注了 Children ToolSet 架构的特殊要求和最佳实践。