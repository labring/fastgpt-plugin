# KnowS 插件开发日志

## 2025-01-17 - API Key 安全配置重构

### 🔧 修改内容
#### 1. 移除默认 API Key，提升安全性
- **修改文件**: `shared/config.ts`
- **关键变更**:
  - 移除 `KNOWS_ENVIRONMENTS` 中的 `defaultApiKey` 字段
  - 修改 `getKnowsConfig` 函数，将 `apiKey` 参数改为必填
  - 添加 API Key 验证逻辑，提供清晰的错误提示

#### 2. 为所有子工具添加 API Key 输入配置
- **修改文件**: 
  - `children/search/config.ts`
  - `children/analysis/config.ts`
  - `children/summary/config.ts`
  - `children/details/config.ts`
  - `children/history/config.ts`
  - `children/management/config.ts`
- **关键变更**:
  - 导入 `defineInputConfig` 工具函数
  - 在每个工具的 `inputs` 数组开头添加 API Key 配置
  - 使用 `secret` 类型确保密钥安全输入

#### 3. 更新工具实现
- **修改文件**: `children/search/src/index.ts`
- **关键变更**:
  - 将 `InputType` 中的 `apiKey` 改为必填字段
  - 调整参数解构顺序，优先处理 `apiKey`
  - 添加 `maxResults` 参数支持

### 🎯 技术要点
#### API Key 配置模式
```typescript
defineInputConfig([
  {
    key: 'apiKey',
    label: 'KnowS API Key',
    description: 'KnowS 平台的 API 密钥',
    required: true,
    inputType: 'secret'  // 确保密钥安全输入
  }
])
```

#### 配置获取方式
```typescript
// 现在 apiKey 是必填参数
const config = getKnowsConfig(apiKey, environment);
```

#### 错误处理优化
```typescript
if (!apiKey) {
  throw new Error('API Key 是必填项，请在工具配置中输入有效的 KnowS API Key');
}
```

### ✅ 安全特性
1. **无默认密钥**: 完全移除默认 API Key，避免泄露风险
2. **强制配置**: 用户必须主动输入 API Key 才能使用工具
3. **密钥保护**: 使用 `secret` 类型确保输入时密钥不可见
4. **清晰提示**: 提供明确的错误信息指导用户配置

### 🔄 用户体验
1. **一致性**: 所有子工具都采用相同的 API Key 配置方式
2. **简单性**: 参考 `bing` 工具的简单直接模式
3. **安全性**: 每次使用都需要输入 API Key，确保安全
4. **友好性**: 清晰的标签和描述帮助用户理解配置

### 📝 后续计划
1. 更新其他子工具的实现代码，确保与新的 API Key 配置兼容
2. 测试所有工具的 API Key 验证逻辑
3. 更新用户文档，说明新的配置方式

---

## 2025-01-17 - API 标准化调整

### 问题描述
根据 `KnowS_API_Documentation.md` 标准文档，发现 Summary 工具的实现与 API 文档不完全一致：
1. 输入类型定义中包含了 API 不支持的 `ALL` 选项
2. 处理逻辑中包含了不必要的 `ALL` 选项展开逻辑

### 修复内容

#### 1. Summary 工具 API 标准化
- **移除不支持的选项**: 从输入类型定义中移除 `ALL` 选项，严格按照 API 文档支持的 `CLINICAL`, `RESEARCH`, `POPULAR_SCIENCE` 三种类型
- **简化输入验证**: 移除处理 `ALL` 选项的复杂逻辑，直接使用用户选择的类型
- **优化参数传递**: 直接将用户选择的 `answer_type` 传递给 API，确保与文档定义完全一致
- **增强输入验证**: 添加对 `questionId` 和 `answerType` 的空值检查

#### 2. API 文档一致性验证
- **Search 工具验证**: 确认 search 工具的实现与 `/knows/ai_search` 接口文档完全一致
- **类型定义验证**: 确认 `shared/types.ts` 中的类型定义与 API 文档匹配
- **响应字段映射**: 验证 API 响应字段映射的正确性

### 技术要点

#### API 接口标准
- **`/knows/answer` 接口**:
  - 请求参数: `question_id` (String), `answer_type` (Enum[])
  - 支持的 `answer_type`: `CLINICAL`, `RESEARCH`, `POPULAR_SCIENCE`
  - 响应格式: `content` (String) - 文本内容和引用id混杂，引用id用{}包裹

- **`/knows/ai_search` 接口**:
  - 请求参数: `query` (String), `data_scope` (Enum[])
  - 支持的 `data_scope`: `PAPER`, `PAPER_CN`, `GUIDE`, `MEETING`
  - 响应格式: `question_id`, `evidences[]` 包含 `id`, `title`, `type`, `label`, `has_pdf`

#### 代码优化
- **类型安全**: 确保 TypeScript 类型定义与 API 文档完全匹配
- **参数验证**: 添加必要的输入参数验证，提供友好的错误提示
- **错误处理**: 保持现有的错误处理机制，针对不同错误类型提供具体的用户提示

### 验证结果
- ✅ 构建成功，无 TypeScript 错误
- ✅ API 接口定义与文档完全一致
- ✅ 类型安全得到保障
- ✅ 输入验证逻辑优化

### 关键经验
1. **严格遵循 API 文档**: 工具实现必须与 API 文档保持完全一致，不应添加 API 不支持的功能
2. **简化业务逻辑**: 移除不必要的复杂逻辑，直接使用 API 标准参数
3. **类型安全优先**: 确保 TypeScript 类型定义准确反映 API 接口规范
4. **文档驱动开发**: 以 API 文档为准，确保实现的准确性和一致性

---

## 2025-01-17 - KnowS Summary 工具 API 集成修复

### 问题描述
用户反馈 `summary` 工具使用的是模拟数据，需要根据 KnowS API 文档中的 `/knows/answer` 接口进行真实 API 调用。

### 修复内容

#### 1. API 集成替换
- **原问题**: 工具使用模拟数据生成总结内容，包含固定的模拟延迟和预设的总结模板
- **修复方案**: 集成真实的 KnowS `/knows/answer` API
- **关键修改**:
  ```typescript
  // 替换模拟数据生成
  const request: AnswerRequest = {
    question_id: questionId,
    answer_type: filteredTypes
  };
  const response = await client.getAnswer(request);
  ```

#### 2. 导入导出结构修复
- **原问题**: 
  - 错误导入不存在的 `ToolInputType`, `ToolOutputType`
  - 错误导入 `getKnowsConfig` 从 api.ts
  - 导出 `main` 函数而非 `tool` 函数
- **修复方案**:
  ```typescript
  // 正确的类型导入
  import type { AnswerRequest, AnswerType } from '../../../shared/types';
  import { createKnowsClient } from '../../../shared/api';
  import { getKnowsConfig } from '../../../shared/config';
  
  // 正确的导出结构
  export const InputType = z.object({...});
  export const OutputType = z.object({...});
  export async function tool(input: InputType): Promise<OutputType>
  ```

#### 3. 类型安全增强
- **类型转换**: 正确处理 `AnswerType[]` 类型转换
- **类型导入**: 使用 `type` 关键字进行类型导入，避免运行时导入
- **错误处理**: 增强错误类型检查和友好错误提示

#### 4. 业务逻辑优化
- **ALL 选项处理**: 保持原有的 ALL 选项扩展逻辑
- **类型过滤**: 正确过滤和转换 answerType 数组
- **响应处理**: 直接使用 API 响应的 content 字段

### 技术要点

#### API 客户端使用
```typescript
// 配置管理
const config = getKnowsConfig();
const client = createKnowsClient(config);

// API 调用
const response = await client.getAnswer({
  question_id: questionId,
  answer_type: filteredTypes
});
```

#### 错误处理策略
- **网络错误**: fetch 相关错误提示检查网络连接
- **认证错误**: 401/403 错误提示检查 API 密钥
- **资源错误**: 404 错误提示问题 ID 不存在
- **超时错误**: timeout 错误提示稍后重试

#### 类型安全保障
- 使用 TypeScript 严格类型检查
- 正确的类型导入和导出
- API 请求和响应类型匹配

### 验证结果
- ✅ 构建成功，无 TypeScript 错误
- ✅ API 客户端正确集成
- ✅ 类型定义完整匹配
- ✅ 错误处理机制完善

### 关键经验
1. **API 集成**: 确保 API 请求参数与文档完全匹配
2. **类型导入**: 区分类型导入和值导入，使用 `type` 关键字
3. **工具结构**: FastGPT 工具需要导出 `tool` 函数和相应的类型定义
4. **配置管理**: 使用统一的配置管理系统，支持环境切换
5. **错误恢复**: 提供详细的错误信息和恢复建议

---

## 2025-01-17 - KnowS Search 工具 API 集成修复

### 问题描述
用户反馈 `search` 工具执行时出现 `fetch failed` 错误，经检查发现工具仍在使用模拟数据而非真实的 KnowS API。

### 修复内容

#### 1. API 集成替换
- **原问题**: 工具使用模拟数据生成检索结果，包含固定的模拟证据列表
- **修复方案**: 集成真实的 KnowS `aiSearch` API
- **关键修改**:
  ```typescript
  // 替换模拟数据生成
  const response = await client.aiSearch({
    query: question,
    data_scope: dataScope
  });
  ```

#### 2. API 字段映射修复
- **原问题**: API 请求字段名称不匹配
  - 使用 `question` 而非 `query`
  - 包含不存在的 `answer_type` 字段
- **修复方案**: 
  ```typescript
  // 正确的 API 请求结构
  const request: AiSearchRequest = {
    query: question,        // 修正字段名
    data_scope: dataScope   // 移除 answer_type
  };
  ```

#### 3. 响应字段映射修复
- **原问题**: 响应字段名称不匹配
  - 使用 `evidence.labels` 而非 `evidence.label`
- **修复方案**:
  ```typescript
  // 正确的字段映射
  labels: evidence.label || '未分类'  // 修正字段名
  ```

#### 4. 错误处理增强
- **日志增强**: 添加详细的请求和响应日志
- **错误恢复**: 提供友好的错误提示和恢复建议
- **类型安全**: 确保 API 响应类型匹配

### 技术要点

#### API 客户端集成
```typescript
// 配置和客户端创建
const config = getKnowsConfig();
const client = createKnowsClient(config);

// API 调用
const response = await client.aiSearch(request);
```

#### 环境配置管理
- 支持开发和生产环境配置
- 默认 API 密钥管理
- 超时配置支持

#### 类型安全保障
- 严格的 TypeScript 类型检查
- API 请求和响应类型匹配
- 错误类型处理

### 验证结果
- ✅ 构建成功，无 TypeScript 错误
- ✅ API 客户端正确集成
- ✅ 字段映射完全匹配
- ✅ 错误处理机制完善

### 关键经验
1. **字段映射**: 确保 API 请求和响应字段名称与文档完全一致
2. **类型匹配**: 使用 TypeScript 类型定义确保 API 调用的类型安全
3. **错误处理**: 提供详细的错误信息和调试日志
4. **配置管理**: 使用统一的配置系统管理 API 密钥和环境设置