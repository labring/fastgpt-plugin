# FastGPT 插件开发日志

## 2025-01-17 - Metaso 插件工作流集成确认

### 📋 工作流集成需求确认
- **需求**: 确认 Metaso 插件可以通过 query 参数接收工作流上一节点或起始节点的数据
- **结论**: ✅ **完全支持**

### 🔍 技术调研结果

#### 1. FastGPT 工作流集成机制
通过分析现有插件（如 JinaAI、百度搜索等），确认 FastGPT 插件支持以下输入方式：

**输入参数配置**:
```typescript
{
  key: 'query',
  label: '搜索关键词', 
  required: true,
  valueType: WorkflowIOValueTypeEnum.string,
  renderTypeList: [
    FlowNodeInputTypeEnum.reference,  // 引用其他节点输出
    FlowNodeInputTypeEnum.input       // 手动输入
  ]
}
```

#### 2. 支持的数据传递方式
- **reference 模式**: 直接引用上一节点的输出字段
- **全局变量**: 通过 FastGPT 全局变量传递数据
- **多节点串联**: 支持多个工具节点组合使用

#### 3. Metaso 插件适配方案
所有三个子工具的主要输入参数都将支持工作流集成：
- **搜索工具**: `query` 参数支持 reference + input
- **问答工具**: `question` 参数支持 reference + input  
- **网页读取工具**: `url` 参数支持 reference + input

### 📝 设计文档更新
- ✅ 为所有子工具添加工作流集成说明
- ✅ 新增"工作流集成配置"专门章节
- ✅ 提供三种典型工作流嵌入场景示例
- ✅ 明确参数传递机制和配置标准

### 🎯 工作流嵌入场景
1. **智能搜索链**: 用户输入 → 关键词提取 → Metaso搜索 → 结果整理
2. **问答增强**: 用户问题 → 问题分析 → Metaso问答 → 答案验证  
3. **网页内容分析**: URL输入 → 内容提取 → 内容分析 → 摘要生成

### ✅ 确认结论
Metaso 插件设计完全满足工作流嵌入要求，可以无缝接收上一节点或起始节点的 query 数据，支持灵活的工作流组合使用。

---

## 2025-01-17 - 修复 "Cannot read properties of undefined (reading '0')" 错误

### 问题描述
FastGPT 主程序无法显示插件，控制台报错：`Cannot read properties of undefined (reading '0')`

### 错误原因分析
通过对比 `jinaAi` 插件的正确配置，发现 `knows` 插件存在两个关键问题：

1. **缺少 children 数组配置**：`knows` 插件使用 `defineToolSet` 但主配置文件中没有导入和配置 `children` 数组
2. **子工具导出结构错误**：所有子工具使用了错误的导出方式，没有使用 `exportTool` 函数

### 修复方法

#### 1. 修复主配置文件 (config.ts)
```typescript
// 错误的配置 - 缺少 children 导入和配置
export default defineToolSet({
  name: { 'zh-CN': 'KnowS 医学知识检索' },
  // ... 其他配置
  // 缺少 children 数组
});

// 正确的配置 - 添加 children 导入和配置
import search from './children/search';
import analysis from './children/analysis';
// ... 其他子工具导入

export default defineToolSet({
  name: { 'zh-CN': 'KnowS 医学知识检索' },
  // ... 其他配置
  children: [search, analysis, summary, details, history, management]
});
```

#### 2. 修复子工具导出结构
```typescript
// 错误的导出方式
export default {
  InputType,
  OutputType,
  toolCb,
  config
};

// 正确的导出方式 - 使用 exportTool 函数
import { exportTool } from '@tool/utils/tool';

export default exportTool({
  toolCb,
  InputType,
  OutputType,
  config
});
```

### 修复结果
- ✅ 构建成功，无 TypeScript 错误
- ✅ `knows.js` 文件正确生成到 `dist/tools/` 目录
- ✅ 插件配置结构符合 FastGPT 规范

### 关键经验总结
1. **ToolSet 配置必须包含 children 数组**：使用 `defineToolSet` 时必须显式导入所有子工具并配置到 `children` 数组中
2. **子工具必须使用 exportTool 函数**：所有子工具的 `index.ts` 必须使用 `exportTool` 函数来正确导出
3. **参考正确示例**：遇到配置问题时，参考 `jinaAi` 等正确配置的插件结构
4. **构建验证**：每次修复后立即运行 `npm run build` 验证修复效果

## 2025-01-17 - KnowS Search 工具 API 集成修复

### 问题描述
- **问题**: search 工具执行时出现 "fetch failed" 错误
- **原因**: search 工具仍使用模拟数据，未集成真实的 KnowS API
- **影响**: 无法进行真实的医学文献检索

### 修复内容

#### 1. API 集成 (`search/src/index.ts`)
```typescript
// 新增导入
import { createKnowsClient } from '../../../shared/api';
import { getKnowsConfig } from '../../../shared/config';
import type { AiSearchRequest } from '../../../shared/types';

// 替换模拟数据为真实API调用
const config = getKnowsConfig(apiKey, environment);
const client = createKnowsClient(config);
const response = await client.aiSearch(request);
```

#### 2. 字段映射修复
- **修复**: `AiSearchRequest` 字段名从 `question` 改为 `query`
- **修复**: `Evidence.labels` 字段名改为 `Evidence.label`
- **优化**: 移除不存在的 `answer_type` 字段

#### 3. 错误处理增强
```typescript
// 详细的错误分类和提示
if (error.message.includes('fetch')) {
  errorMessage = '网络连接失败，请检查网络连接或API服务状态';
} else if (error.message.includes('API Error')) {
  errorMessage = `API调用失败: ${error.message}`;
} else if (error.message.includes('Business Error')) {
  errorMessage = `业务错误: ${error.message}`;
}
```

#### 4. 日志增强
- 添加详细的请求日志记录
- 包含查询内容、数据范围、API环境等信息
- 统一日志前缀 `[KnowS Search]`

### 技术要点

#### API 配置管理
- 支持 `production` 和 `development` 环境
- 默认使用生产环境 API
- 支持自定义 API Key 或使用默认密钥

#### 类型安全
- 严格按照 `shared/types.ts` 中的类型定义
- 确保请求和响应字段映射正确
- 避免运行时类型错误

#### 错误恢复
- 网络错误时提供明确的故障排除建议
- 区分 API 错误和业务逻辑错误
- 保持工具输出格式的一致性

### 验证结果
- ✅ TypeScript 编译通过
- ✅ 构建成功，无类型错误
- ✅ API 客户端正确集成
- ✅ 错误处理机制完善

### 关键经验
1. **API 集成**: 确保字段名称与 API 文档完全一致
2. **类型定义**: 严格遵循共享类型定义，避免字段名不匹配
3. **错误处理**: 提供用户友好的错误信息，便于问题诊断
4. **环境配置**: 支持多环境配置，便于开发和生产部署

## 2024-12-19 文档整理和开发指南完善

### 📝 任务概述
- 修改项目作者信息为 "xiaoyibao team"
- 提炼 children 结构工具开发要点，创建专项开发指南
- 完善 AI 编程模板文档体系

### 🔧 主要修改

#### 1. 作者信息更新
**文件**: `/modules/tool/packages/knows/config.ts`
**修改内容**:
```typescript
// 修改前
author: 'FastGPT'

// 修改后  
author: 'xiaoyibao team'
```

#### 2. 创建 Children 工具开发指南
**新文件**: `/AI_coding_templates/Children_ToolSet_Development_Guide.md`
**内容要点**:
- **项目结构规范**: ToolSet 主配置 + children 子工具结构
- **配置管理**: 主配置文件的 children 数组配置要点
- **类型定义规范**: 统一驼峰命名约定，避免下划线命名
- **核心实现**: exportTool 函数使用和导入路径规范
- **错误处理**: API Key 类型定义和参数验证最佳实践
- **常见陷阱**: 
  - ToolSet 缺少 children 数组导致的运行时错误
  - 参数命名不一致导致的 TypeScript 错误
  - API Key 可选/必填类型定义问题
- **开发流程**: 单一功能优先 → 验证正确 → 复制扩展的开发策略
- **验证工具**: TypeScript 检查命令和构建验证方法

#### 3. 更新主开发指南
**文件**: `/AI_coding_templates/AI_coding_guide.md`
**新增内容**:
- 添加"专项开发指南"章节
- 引用 Children 结构工具开发指南
- 说明该指南适用于复杂工具集开发场景

### 📊 开发成果总结

#### 技术要点提炼
1. **ToolSet 配置管理**
   - 主配置文件必须包含 children 数组
   - 子工具必须使用 exportTool 函数导出
   - 导入路径规范: './src' 而非 './src/index'

2. **类型安全保障**
   - 统一使用驼峰命名约定 (analysisType, evidenceId 等)
   - API Key 参数必须定义为必填类型
   - 添加 environment 参数支持多环境配置

3. **错误预防机制**
   - TypeScript 严格类型检查
   - 单一功能优先开发策略
   - 完整的验证流程和工具

#### 文档体系完善
- **主指南**: AI_coding_guide.md - 通用开发规范和最佳实践
- **专项指南**: Children_ToolSet_Development_Guide.md - children 结构工具开发专项指南
- **开发日志**: 详细记录开发过程、问题解决和技术要点

### 🎯 价值和意义
1. **避坑指南**: 总结了 children 结构工具开发中的常见陷阱和解决方案
2. **标准化流程**: 建立了规范的开发流程和验证机制  
3. **知识沉淀**: 将实际开发经验转化为可复用的开发指南
4. **团队协作**: 为 xiaoyibao team 后续开发提供标准化参考

### 🔍 技术验证
- TypeScript 检查: ✅ 0 错误
- 文档结构: ✅ 完整且有序
- 引用链接: ✅ 正确可访问
- 内容覆盖: ✅ 涵盖关键开发要点

## 2024-12-19 自定义图标配置

### 📝 任务概述
- 为 xiaoyibao 和 clinicalTrials 工具创建自定义 SVG 图标
- 修改配置文件使用自定义图标替代默认图标

### 🎨 图标设计

#### 1. xiaoyibao 工具图标
**文件**: `/modules/tool/packages/xiaoyibao/logo.svg`
**设计元素**:
- 绿色圆形背景 (#4CAF50) - 代表健康和希望
- 白色医疗十字 - 象征医疗服务
- 红色爱心元素 - 体现关爱患者的理念
- 24x24 像素 SVG 格式，适配 FastGPT 界面

#### 2. clinicalTrials 工具图标  
**文件**: `/modules/tool/packages/clinicalTrials/logo.svg`
**设计元素**:
- 蓝色文档背景 (#E3F2FD) - 代表专业和科学
- 文档线条 - 象征临床试验报告
- 绿色医疗十字 - 医疗标识
- 橙色搜索图标 - 体现搜索功能

### 🔧 配置修改

#### xiaoyibao 工具
```typescript
// 修改前
icon: 'core/workflow/template/httpRequest'

// 修改后
icon: 'plugins/xiaoyibao'
```

#### clinicalTrials 工具
```typescript
// 修改前  
icon: 'core/workflow/template/httpRequest'

// 修改后
icon: 'plugins/clinicalTrials'
```

### 📋 自定义图标操作指南

#### 方法一：SVG 文件（推荐）
1. **创建 SVG 文件**：在工具目录下创建 `logo.svg` 文件
2. **设计要求**：
   - 使用 24x24 像素的 viewBox
   - 简洁明了的设计风格
   - 符合工具功能特点的视觉元素
   - 适配浅色和深色主题

3. **配置引用**：
   ```typescript
   export default defineTool({
     icon: 'plugins/工具名称', // 使用自定义图标
     // 其他配置...
   });
   ```

#### 方法二：使用 FastGPT 内置图标
```typescript
// 常用内置图标示例
icon: 'core/workflow/template/httpRequest'  // HTTP 请求
icon: 'core/workflow/template/search'       // 搜索
icon: 'core/workflow/template/ai'          // AI 相关
icon: 'core/workflow/template/database'    // 数据库
icon: 'core/app/toolCall'                  // 工具调用
```

### 🎯 技术要点
1. **图标命名规范**：`plugins/工具名称` 格式
2. **文件位置**：工具根目录下的 `logo.svg` 文件
3. **SVG 优势**：矢量格式，支持缩放，文件小
4. **设计一致性**：保持与 FastGPT 整体 UI 风格协调

### ✅ 验证结果
- xiaoyibao 工具：✅ 自定义图标配置完成
- clinicalTrials 工具：✅ 自定义图标配置完成
- 图标文件：✅ SVG 格式，符合设计规范
- 配置文件：✅ 正确引用自定义图标

---

## 2024-12-19 - knows 插件 search 功能优化

### 优化内容
为 `knows` 插件的 `search` 子工具添加 `dataScope` 默认值配置，使其默认检索全部数据范围。

### 具体修改

#### 1. 输入类型优化 (src/index.ts)
- 为 `dataScope` 参数设置默认值为全部数据范围：`['PAPER', 'PAPER_CN', 'GUIDE', 'MEETING']`
- 使用 Zod 的 `.default()` 方法确保参数有默认值

#### 2. 业务逻辑优化 (src/index.ts)
- 重构检索逻辑，根据 `dataScope` 参数动态生成对应的模拟数据
- 添加会议文献 (`MEETING`) 类型的支持
- 优化摘要生成逻辑，动态统计文献类型和PDF数量
- 添加详细的中文注释说明各个处理步骤

#### 3. 配置文件优化 (config.ts)
- 添加 `dataScope` 参数到 FastGPT 界面配置
- 使用 `multipleSelect` 渲染类型，支持多选
- 设置默认值为全部数据范围，用户可根据需要调整
- 提供友好的中文标签：英文文献、中文文献、指南文档、会议文献

### 技术要点
1. **Zod 默认值设置**：使用 `.default()` 方法为数组类型设置默认值
2. **多选配置**：使用 `FlowNodeInputTypeEnum.multipleSelect` 实现多选界面
3. **动态数据生成**：根据用户选择的数据范围动态生成对应的检索结果
4. **类型安全**：保持 TypeScript 类型安全，确保配置和实现的一致性

### 修复的问题
- **配置不一致**：解决了 `config.ts` 中缺少 `dataScope` 参数配置的问题
- **类型错误**：修复了 `selectMultiple` 不存在的错误，改为正确的 `multipleSelect`
- **用户体验**：提供了默认的全范围检索，同时允许用户自定义选择

### 验证结果
- ✅ `npm run build` 构建成功
- ✅ 类型检查通过
- ✅ 配置文件语法正确
- ✅ 默认值设置生效

### 关键经验
1. **参数一致性**：确保 Zod schema、配置文件和实现逻辑中的参数保持一致
2. **默认值设计**：为用户提供合理的默认值，减少配置负担
3. **类型验证**：使用正确的 FastGPT 枚举类型，避免拼写错误
4. **用户友好**：提供清晰的中文标签和描述，提升用户体验

---

## 2024-12-19 - knows 插件修复

### 问题描述
在构建 `knows` 插件时遇到 `Cannot read properties of undefined (reading '0')` 错误，导致插件无法正常生成。

### 错误原因分析
1. **缺少 children 数组配置**：主配置文件 `config.ts` 中没有配置 `children` 数组
2. **子工具导出结构错误**：所有子工具都使用了错误的导出方式，没有使用 `exportTool` 函数

### 修复方法

#### 1. 主配置文件修复
在 `modules/tool/packages/knows/config.ts` 中：
- 添加所有子工具的导入
- 配置 `children` 数组包含所有子工具

#### 2. 子工具导出结构修复
修复了以下6个子工具的导出结构：
- `search/index.ts`
- `analysis/index.ts` 
- `summary/index.ts`
- `details/index.ts`
- `history/index.ts`
- `management/index.ts`

将错误的直接导出：
```typescript
export default {
  InputType,
  OutputType,
  toolCb,
  config
};
```

修改为正确的 `exportTool` 导出：
```typescript
export default exportTool({
  toolCb,
  InputType,
  OutputType,
  config
});
```

### 修复结果
- ✅ `npm run build` 构建成功
- ✅ `knows.js` 文件成功生成到 `dist/tools/` 目录
- ✅ 所有子工具配置规范

### 关键经验总结
1. **ToolSet 必须配置 children**：主配置文件必须包含 `children` 数组
2. **子工具必须使用 exportTool**：所有子工具必须使用 `exportTool` 函数导出
3. **参考正确示例**：可以参考 `jinaAiSearch` 等正确配置的插件
4. **及时验证**：每次修改后立即运行 `npm run build` 验证

---

## 2024-12-19 - 开发文档更新

### 更新内容
基于 `knows` 插件修复经验，更新了以下开发文档：

#### 1. knows 插件开发设计文档
- 添加了 "Cannot read properties of undefined (reading '0')" 错误修复指南
- 提供了错误和正确的代码示例
- 明确了关键检查点

#### 2. AI 编码指南 (AI_coding_guide.md)
- 添加了 ToolSet 配置错误的详细修复方法
- 提供了完整的错误预防代码示例
- 强调了关键检查点的重要性

#### 3. AI 初始模板 (AI_INITIAL_template.md)
- 在开发检查清单中添加了 ToolSet 配置检查项
- 增加了关键错误检查步骤
- 强化了验证流程

#### 4. AI 程序员提示词 (AI_programmer_prompt.md)
- 将 ToolSet 配置错误设为最高优先级预防项
- 添加了详细的检查清单
- 提供了其他高频错误的预防示例

#### 5. 新增 ToolSet 配置模板 (ToolSet_Config_Template.md)
- 创建了专门的 ToolSet 配置模板文件
- 提供了完整的主配置和子工具配置示例
- 详细列出了常见错误和成功标准

### 更新目标
通过这些文档更新，确保 AI 在未来开发中能够：
1. 避免 "Cannot read properties of undefined" 错误
2. 正确配置 ToolSet 和子工具结构
3. 遵循最佳实践进行插件开发
4. 快速定位和修复配置问题

### 关键改进
- **错误预防**：从源头预防常见配置错误
- **模板标准化**：提供标准化的配置模板
- **检查清单**：明确的开发验证步骤
- **示例对比**：错误vs正确的代码对比

这些更新将显著提高插件开发的成功率和效率。

---

## 2025-01-27

### 图标配置修正

#### 问题描述
- `xiaoyibao` 工具的自定义图标无法正常显示
- `clinicalTrials` 工具同样存在图标显示问题
- 原因是配置文件中使用了错误的 `plugins/xiaoyibao` 路径格式

#### 分析过程
通过分析 FastGPT 插件系统的图标处理机制，发现：
1. 构建脚本会将工具目录下的 `logo.svg` 自动复制到 `public/imgs/tools/{工具名}.svg`
2. 配置文件中应使用 `/imgs/tools/{工具名}.svg` 格式
3. `plugins/` 路径格式是错误的，不符合 FastGPT 规范

#### 修复内容

**xiaoyibao 工具修复**:
- 文件: `modules/tool/packages/xiaoyibao/config.ts`
- 修改: `icon: 'plugins/xiaoyibao'` → `icon: '/imgs/tools/xiaoyibao.svg'`

**clinicalTrials 工具修复**:
- 文件: `modules/tool/packages/clinicalTrials/config.ts`  
- 修改: `icon: 'plugins/clinicalTrials'` → `icon: '/imgs/tools/clinicalTrials.svg'`

#### 构建验证
运行 `bun run build` 验证修复效果：
```
✅ 复制图标: clinicalTrials.svg
✅ 复制图标: xiaoyibao.svg
✅ 构建成功完成
```

#### 技术要点总结

**FastGPT 图标系统机制**:
1. **自动复制**: 构建时将 `{工具目录}/logo.svg` 复制到 `public/imgs/tools/{工具名}.svg`
2. **默认路径**: 如果不指定 `icon`，系统自动使用 `/imgs/tools/{工具名}.svg`
3. **内置图标**: 可使用 `core/workflow/template/httpRequest` 等内置图标
4. **SVG 格式**: 推荐使用 SVG 格式，支持缩放且文件小

**图标配置最佳实践**:
- ✅ 使用 `/imgs/tools/{工具名}.svg` 格式
- ✅ 确保工具目录下有 `logo.svg` 文件
- ✅ 运行构建脚本复制图标文件
- ❌ 避免使用 `plugins/` 路径格式

#### 验证结果
- [x] `xiaoyibao.svg` 已复制到 `public/imgs/tools/` 目录
- [x] `clinicalTrials.svg` 已复制到 `public/imgs/tools/` 目录
- [x] 配置文件路径格式正确
- [x] 构建脚本执行成功

#### 关键经验
1. **路径规范**: FastGPT 插件图标必须使用 `/imgs/tools/` 路径格式
2. **构建依赖**: 图标显示依赖构建脚本的执行
3. **文件命名**: 图标文件会被重命名为 `{工具名}.svg`
4. **验证方法**: 通过构建日志确认图标复制状态

### Metaso 插件设计文档创建

#### 项目概述
基于用户需求，为 Metaso API 创建了完整的插件设计文档，采用 Children ToolSet 架构实现三个核心功能：
1. **搜索 (Search)** - 网页内容搜索，支持摘要生成
2. **问答 (Ask)** - 智能问答服务  
3. **网页读取 (Reader)** - 指定URL内容提取和解析

#### 设计要点

**Children 架构特殊要求**:
- 主配置文件必须使用 `defineToolSet` 函数
- 必须包含 `children` 数组，导入所有子工具
- 子工具必须使用 `exportTool` 函数导出
- 导入路径必须是 `'./src'` 而不是 `'./src/index'`

**技术架构设计**:
- 共享模块 (shared/) 统一管理 API 客户端、配置和类型
- 子工具 (children/) 独立实现各自功能
- 强制要求 API Key，提高安全性
- 使用 Zod 进行运行时类型验证

**开发原则**:
- 严格遵循"单一功能优先"原则
- 每个阶段都进行构建验证
- 统一的错误处理机制
- 完善的文档和注释

#### 创建文件
- `modules/tool/packages/metaso/设计文档.md` - 详细的技术设计文档
- `modules/tool/packages/metaso/开发计划.md` - 6天分阶段开发计划

#### 关键技术要点
1. **API Key 配置**: 所有子工具统一使用 secret 类型的 API Key 配置
2. **参数命名**: 采用驼峰命名规范，避免下划线格式
3. **错误处理**: 分层错误处理，提供用户友好的错误提示
4. **类型安全**: 使用 Zod 进行输入输出类型验证

#### 开发计划
制定了详细的6天开发计划：
- 第1天: 项目初始化和共享模块框架
- 第2天: 搜索工具开发（单一功能优先）
- 第3天: 问答工具开发
- 第4天: 网页读取工具开发
- 第5天: 工具集集成
- 第6天: 文档和优化

#### 预期成果
- 功能完整的三子工具工具集
- 符合 FastGPT 开发规范
- 代码质量高，可维护性强
- 用户体验友好

---

## 2025-01-16 - 初始开发

### 项目初始化
- 创建 KnowS 医学知识检索插件
- 设计 6 个子工具：search, analysis, summary, details, history, management
- 配置基础的 TypeScript 类型定义和 API 接口

### 主要开发内容
- 完成插件基础架构设计
- 实现各子工具的配置文件和类型定义
- 建立统一的错误处理机制

### 遇到的问题
- 初期对 FastGPT 插件架构理解不够深入
- 子工具导出结构配置错误

### 解决方案
- 深入研究 FastGPT 插件开发文档
- 参考现有插件的最佳实践