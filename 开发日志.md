# FastGPT 插件开发日志

## 2025-01-17 - 修复 "Cannot read properties of undefined (reading '0')" 错误

### 问题描述
FastGPT 主程序无法显示插件，控制台报错：`Cannot read properties of undefined (reading '0')`

### 错误原因分析
通过对比 `jinaAi` 插件的正确配置，发现 `knows` 插件存在两个关键问题：

1. **缺少 children 数组配置**：`knows` 插件使用 `defineToolSet` 但主配置文件中没有导入和配置 `children` 数组
2. **子工具导出结构错误**：所有子工具使用了错误的导出方式，没有使用 `exportTool` 函数

### 修复方法

#### 1. 修复主配置文件 (config.ts)
```typescript
// 错误的配置 - 缺少 children 导入和配置
export default defineToolSet({
  name: { 'zh-CN': 'KnowS 医学知识检索' },
  // ... 其他配置
  // 缺少 children 数组
});

// 正确的配置 - 添加 children 导入和配置
import search from './children/search';
import analysis from './children/analysis';
// ... 其他子工具导入

export default defineToolSet({
  name: { 'zh-CN': 'KnowS 医学知识检索' },
  // ... 其他配置
  children: [search, analysis, summary, details, history, management]
});
```

#### 2. 修复子工具导出结构
```typescript
// 错误的导出方式
export default {
  InputType,
  OutputType,
  toolCb,
  config
};

// 正确的导出方式 - 使用 exportTool 函数
import { exportTool } from '@tool/utils/tool';

export default exportTool({
  toolCb,
  InputType,
  OutputType,
  config
});
```

### 修复结果
- ✅ 构建成功，无 TypeScript 错误
- ✅ `knows.js` 文件正确生成到 `dist/tools/` 目录
- ✅ 插件配置结构符合 FastGPT 规范

### 关键经验总结
1. **ToolSet 配置必须包含 children 数组**：使用 `defineToolSet` 时必须显式导入所有子工具并配置到 `children` 数组中
2. **子工具必须使用 exportTool 函数**：所有子工具的 `index.ts` 必须使用 `exportTool` 函数来正确导出
3. **参考正确示例**：遇到配置问题时，参考 `jinaAi` 等正确配置的插件结构
4. **构建验证**：每次修复后立即运行 `npm run build` 验证修复效果

## 2025-01-17 - KnowS Search 工具 API 集成修复

### 问题描述
- **问题**: search 工具执行时出现 "fetch failed" 错误
- **原因**: search 工具仍使用模拟数据，未集成真实的 KnowS API
- **影响**: 无法进行真实的医学文献检索

### 修复内容

#### 1. API 集成 (`search/src/index.ts`)
```typescript
// 新增导入
import { createKnowsClient } from '../../../shared/api';
import { getKnowsConfig } from '../../../shared/config';
import type { AiSearchRequest } from '../../../shared/types';

// 替换模拟数据为真实API调用
const config = getKnowsConfig(apiKey, environment);
const client = createKnowsClient(config);
const response = await client.aiSearch(request);
```

#### 2. 字段映射修复
- **修复**: `AiSearchRequest` 字段名从 `question` 改为 `query`
- **修复**: `Evidence.labels` 字段名改为 `Evidence.label`
- **优化**: 移除不存在的 `answer_type` 字段

#### 3. 错误处理增强
```typescript
// 详细的错误分类和提示
if (error.message.includes('fetch')) {
  errorMessage = '网络连接失败，请检查网络连接或API服务状态';
} else if (error.message.includes('API Error')) {
  errorMessage = `API调用失败: ${error.message}`;
} else if (error.message.includes('Business Error')) {
  errorMessage = `业务错误: ${error.message}`;
}
```

#### 4. 日志增强
- 添加详细的请求日志记录
- 包含查询内容、数据范围、API环境等信息
- 统一日志前缀 `[KnowS Search]`

### 技术要点

#### API 配置管理
- 支持 `production` 和 `development` 环境
- 默认使用生产环境 API
- 支持自定义 API Key 或使用默认密钥

#### 类型安全
- 严格按照 `shared/types.ts` 中的类型定义
- 确保请求和响应字段映射正确
- 避免运行时类型错误

#### 错误恢复
- 网络错误时提供明确的故障排除建议
- 区分 API 错误和业务逻辑错误
- 保持工具输出格式的一致性

### 验证结果
- ✅ TypeScript 编译通过
- ✅ 构建成功，无类型错误
- ✅ API 客户端正确集成
- ✅ 错误处理机制完善

### 关键经验
1. **API 集成**: 确保字段名称与 API 文档完全一致
2. **类型定义**: 严格遵循共享类型定义，避免字段名不匹配
3. **错误处理**: 提供用户友好的错误信息，便于问题诊断
4. **环境配置**: 支持多环境配置，便于开发和生产部署

---

## 2024-12-19 - knows 插件 search 功能优化

### 优化内容
为 `knows` 插件的 `search` 子工具添加 `dataScope` 默认值配置，使其默认检索全部数据范围。

### 具体修改

#### 1. 输入类型优化 (src/index.ts)
- 为 `dataScope` 参数设置默认值为全部数据范围：`['PAPER', 'PAPER_CN', 'GUIDE', 'MEETING']`
- 使用 Zod 的 `.default()` 方法确保参数有默认值

#### 2. 业务逻辑优化 (src/index.ts)
- 重构检索逻辑，根据 `dataScope` 参数动态生成对应的模拟数据
- 添加会议文献 (`MEETING`) 类型的支持
- 优化摘要生成逻辑，动态统计文献类型和PDF数量
- 添加详细的中文注释说明各个处理步骤

#### 3. 配置文件优化 (config.ts)
- 添加 `dataScope` 参数到 FastGPT 界面配置
- 使用 `multipleSelect` 渲染类型，支持多选
- 设置默认值为全部数据范围，用户可根据需要调整
- 提供友好的中文标签：英文文献、中文文献、指南文档、会议文献

### 技术要点
1. **Zod 默认值设置**：使用 `.default()` 方法为数组类型设置默认值
2. **多选配置**：使用 `FlowNodeInputTypeEnum.multipleSelect` 实现多选界面
3. **动态数据生成**：根据用户选择的数据范围动态生成对应的检索结果
4. **类型安全**：保持 TypeScript 类型安全，确保配置和实现的一致性

### 修复的问题
- **配置不一致**：解决了 `config.ts` 中缺少 `dataScope` 参数配置的问题
- **类型错误**：修复了 `selectMultiple` 不存在的错误，改为正确的 `multipleSelect`
- **用户体验**：提供了默认的全范围检索，同时允许用户自定义选择

### 验证结果
- ✅ `npm run build` 构建成功
- ✅ 类型检查通过
- ✅ 配置文件语法正确
- ✅ 默认值设置生效

### 关键经验
1. **参数一致性**：确保 Zod schema、配置文件和实现逻辑中的参数保持一致
2. **默认值设计**：为用户提供合理的默认值，减少配置负担
3. **类型验证**：使用正确的 FastGPT 枚举类型，避免拼写错误
4. **用户友好**：提供清晰的中文标签和描述，提升用户体验

---

## 2024-12-19 - knows 插件修复

### 问题描述
在构建 `knows` 插件时遇到 `Cannot read properties of undefined (reading '0')` 错误，导致插件无法正常生成。

### 错误原因分析
1. **缺少 children 数组配置**：主配置文件 `config.ts` 中没有配置 `children` 数组
2. **子工具导出结构错误**：所有子工具都使用了错误的导出方式，没有使用 `exportTool` 函数

### 修复方法

#### 1. 主配置文件修复
在 `modules/tool/packages/knows/config.ts` 中：
- 添加所有子工具的导入
- 配置 `children` 数组包含所有子工具

#### 2. 子工具导出结构修复
修复了以下6个子工具的导出结构：
- `search/index.ts`
- `analysis/index.ts` 
- `summary/index.ts`
- `details/index.ts`
- `history/index.ts`
- `management/index.ts`

将错误的直接导出：
```typescript
export default {
  InputType,
  OutputType,
  toolCb,
  config
};
```

修改为正确的 `exportTool` 导出：
```typescript
export default exportTool({
  toolCb,
  InputType,
  OutputType,
  config
});
```

### 修复结果
- ✅ `npm run build` 构建成功
- ✅ `knows.js` 文件成功生成到 `dist/tools/` 目录
- ✅ 所有子工具配置规范

### 关键经验总结
1. **ToolSet 必须配置 children**：主配置文件必须包含 `children` 数组
2. **子工具必须使用 exportTool**：所有子工具必须使用 `exportTool` 函数导出
3. **参考正确示例**：可以参考 `jinaAiSearch` 等正确配置的插件
4. **及时验证**：每次修改后立即运行 `npm run build` 验证

---

## 2024-12-19 - 开发文档更新

### 更新内容
基于 `knows` 插件修复经验，更新了以下开发文档：

#### 1. knows 插件开发设计文档
- 添加了 "Cannot read properties of undefined (reading '0')" 错误修复指南
- 提供了错误和正确的代码示例
- 明确了关键检查点

#### 2. AI 编码指南 (AI_coding_guide.md)
- 添加了 ToolSet 配置错误的详细修复方法
- 提供了完整的错误预防代码示例
- 强调了关键检查点的重要性

#### 3. AI 初始模板 (AI_INITIAL_template.md)
- 在开发检查清单中添加了 ToolSet 配置检查项
- 增加了关键错误检查步骤
- 强化了验证流程

#### 4. AI 程序员提示词 (AI_programmer_prompt.md)
- 将 ToolSet 配置错误设为最高优先级预防项
- 添加了详细的检查清单
- 提供了其他高频错误的预防示例

#### 5. 新增 ToolSet 配置模板 (ToolSet_Config_Template.md)
- 创建了专门的 ToolSet 配置模板文件
- 提供了完整的主配置和子工具配置示例
- 详细列出了常见错误和成功标准

### 更新目标
通过这些文档更新，确保 AI 在未来开发中能够：
1. 避免 "Cannot read properties of undefined" 错误
2. 正确配置 ToolSet 和子工具结构
3. 遵循最佳实践进行插件开发
4. 快速定位和修复配置问题

### 关键改进
- **错误预防**：从源头预防常见配置错误
- **模板标准化**：提供标准化的配置模板
- **检查清单**：明确的开发验证步骤
- **示例对比**：错误vs正确的代码对比

这些更新将显著提高插件开发的成功率和效率。

---

## 2025-01-16 - 初始开发

### 项目初始化
- 创建 KnowS 医学知识检索插件
- 设计 6 个子工具：search, analysis, summary, details, history, management
- 配置基础的 TypeScript 类型定义和 API 接口

### 主要开发内容
- 完成插件基础架构设计
- 实现各子工具的配置文件和类型定义
- 建立统一的错误处理机制

### 遇到的问题
- 初期对 FastGPT 插件架构理解不够深入
- 子工具导出结构配置错误

### 解决方案
- 深入研究 FastGPT 插件开发文档
- 参考现有插件的最佳实践